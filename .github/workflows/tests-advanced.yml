# Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ workflow Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ‚ÐµÑÑ‚Ð¾Ð² UI Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°Ð¼Ð¸
name: Advanced UI Tests

# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑÐºÐ° workflow
on:
  push:
    branches: [main, develop]  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main Ð¸Ð»Ð¸ develop
  pull_request:
    branches: [main]           # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ PR Ð² main
  schedule:
    - cron: '0 2 * * *'       # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð² 2:00 UTC
  workflow_dispatch:          # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

# Ð—Ð°Ð´Ð°Ð½Ð¸Ñ workflow
jobs:
  # Ð›Ð¸Ð½Ñ‚Ð¸Ð½Ð³ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy
          pip install -r requirements.txt

      - name: Run flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run type checking with mypy
        run: mypy . --ignore-missing-imports || true

  # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ UI Ñ‚ÐµÑÑ‚Ñ‹
  ui-tests:
    name: UI Tests
    runs-on: ubuntu-latest
    needs: lint  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð°
    
    strategy:
      fail-fast: false  # ÐÐµ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ
      matrix:
        browser: [chromium, firefox, webkit]  # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð° Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°Ñ…

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # ÐšÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ pip Ð¿Ð°ÐºÐµÑ‚Ñ‹

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps ${{ matrix.browser }}

      - name: Create test data directory
        run: |
          mkdir -p testdata/files
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
          if [ ! -f testdata/files/image.png ]; then
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ 1x1 Ð¿Ð¸ÐºÑÐµÐ»ÑŒ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
            python3 -c "
            from PIL import Image
            import os
            os.makedirs('testdata/files', exist_ok=True)
            img = Image.new('RGB', (100, 100), color='red')
            img.save('testdata/files/image.png')
            print('Test image created')
            " || echo "Pillow not available, skipping image creation"
          fi

      - name: Run tests for ${{ matrix.browser }}
        env:
          BROWSERS: '["${{ matrix.browser }}"]'
          HEADLESS: 'true'
        run: |
          pytest tests/ \
            -m regression \
            -k "${{ matrix.browser }}" \
            --alluredir=allure-results-${{ matrix.browser }} \
            --maxfail=3 \
            -v

      - name: Upload test artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            allure-results-${{ matrix.browser }}/
            videos/
            tracing/
          retention-days: 30

  # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ð¾Ð³Ð¾ Allure Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
  generate-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: ui-tests
    if: always()  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ ÑƒÐ¿Ð°Ð»Ð¸

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Merge Allure results
        run: |
          mkdir -p allure-results
          find artifacts -name "allure-results-*" -type d -exec cp -r {}/* allure-results/ \;

      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@v1.7
        if: always()
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20  # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 20 Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  # Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ñ…
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [ui-tests, generate-report]
    if: always()

    steps:
      - name: Create notification message
        run: |
          if [ "${{ needs.ui-tests.result }}" == "success" ]; then
            echo "âœ… All UI tests passed successfully!" >> notification.txt
          else
            echo "âŒ Some UI tests failed. Check the Allure report." >> notification.txt
          fi
          echo "ðŸ“Š Allure Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> notification.txt

      - name: Display notification
        run: cat notification.txt
